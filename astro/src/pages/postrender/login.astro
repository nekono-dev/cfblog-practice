---
export const prerender = false;
import { UsersApi } from '@/client';
import Metadatas from '@/components/Metadatas.astro';
import { config } from '@/lib/apiClientConfig';

let handleInput = '';
let passwddInput = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const handle = formData.get('handle') as string;
  const passwd = formData.get('passwd') as string;
  handleInput = handle;
  passwddInput = passwd;
  const userApi = new UsersApi(config);
  try {
    const postResult = await userApi.usersTokenPost({
      usersPostRequest: {
        handle,
        passwd,
      },
    });
    Astro.cookies.set('token', String(postResult.token));
    return Astro.redirect('post');
  } catch {
    console.log('login failed');
  }
}

const pageUrl = Astro.url.pathname;

const pageTitle = 'cfblog-practice';
const ogpImgUrl = 'ogpImage.png';
const robots = ['index', 'follow', 'noarchive', 'noimageindex'];
---

<html lang="ja">
  <head prefix="og: https://ogp.me/ns#">
    <Metadatas
      pageTitle={pageTitle}
      subPath={pageUrl}
      ogpImgUrl={ogpImgUrl}
      robots={robots}
    />
  </head>
  <body>
    <h1>Cfblog-practice</h1>
    <form method="post">
      <div>
        <label for="handle">Handle</label>
        <input type="text" name="handle" id="handle" value={handleInput} />
      </div>
      <div>
        <label for="passwd">Password</label>
        <input
          type="password"
          name="passwd"
          id="passwd"
          value={passwddInput}
          required
        />
      </div>
      <button>Login</button>
    </form>
  </body>
</html>
